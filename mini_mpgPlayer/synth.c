#include "synth.h"
#include <math.h>

#define M_PI       3.14159265358979323846
#define M_SQRT2	1.41421356237309504880

/*
coefficients Di for the synthesis window
*/
static float _D[512] =
{
	0.00000, -0.15259, -0.15259, -0.15259,
	-0.15259, -0.15259, -0.15259, -0.30518,
	-0.30518, -0.30518, -0.30518, -0.45776,
	-0.45776, -0.61035, -0.61035, -0.76294,
	-0.76294, -0.91553, -1.06812, -1.06812,
	-1.22070, -1.37329, -1.52588, -1.67847,
	-1.98364, -2.13623, -2.44141, -2.59399,
	-2.89917, -3.20435, -3.66211, -3.96729,
	-4.42505, -4.73022, -5.34058, -5.79834,
	-6.25610, -6.86646, -7.47681, -8.08716,
	-8.85010, -9.61304, -10.37598, -11.13892,
	-12.05444, -12.96997, -13.88550, -14.80103,
	-15.86914, -16.93726, -17.85278, -19.07349,
	-20.14160, -21.20972, -22.43042, -23.49854,
	-24.56665, -25.78735, -26.85547, -27.92358,
	-28.99170, -29.90723, -30.82275, -31.73828,
	32.50122, 33.26416, 33.87451, 34.33228,
	34.63745, 34.79004, 34.79004, 34.63745,
	34.17969, 33.72192, 32.80640, 31.73828,
	30.51758, 28.83911, 27.00806, 24.87183,
	22.27783, 19.37866, 16.17432, 12.66479,
	8.69751, 4.42505, -0.30518, -5.49316,
	-10.98633, -16.93726, -23.34595, -30.05981,
	-37.23145, -44.86084, -52.94800, -61.18774,
	-70.03784, -79.19312, -88.65356, -98.41919,
	-108.48999, -118.86597, -129.39453, -140.22827,
	-151.21460, -162.35352, -173.49243, -184.63135,
	-195.77026, -206.90918, -217.89551, -228.57666,
	-239.10522, -249.32861, -259.09424, -268.40210,
	-277.25220, -285.33936, -292.81616, -299.37744,
	-305.32837, -310.05859, -313.87329, -316.61987,
	-318.14575, -318.45093, -317.38281, -314.78882,
	310.82153, 305.17578, 297.85156, 288.84888,
	278.01514, 265.35034, 250.85449, 234.22241,
	215.75928, 195.31250, 172.57690, 148.01025,
	121.15479, 92.31567, 61.34033, 28.22876,
	-6.86646, -43.94531, -83.16040, -124.20654,
	-167.08374, -211.79199, -258.17871, -306.09131,
	-355.52979, -406.34155, -458.37402, -511.32202,
	-565.33813, -619.96460, -675.20142, -730.59082,
	-786.28540, -841.82739, -897.06421, -951.69067,
	-1005.40161, -1058.19702, -1109.46655, -1159.21021,
	-1206.97021, -1252.59399, -1295.62378, -1335.90698,
	-1372.98584, -1406.70776, -1436.76758, -1462.55493,
	-1484.22241, -1501.15967, -1513.06152, -1519.62280,
	-1520.69092, -1515.96069, -1504.97437, -1487.73193,
	-1463.62305, -1432.64771, -1394.50073, -1348.87695,
	-1295.77637, -1234.74121, -1165.77148, -1088.56201,
	1003.11279, 909.27124, 806.88477, 695.95337,
	576.17187, 447.84546, 3108.2153, 165.10010,
	10.68115, -152.28271, -323.79150, -503.54004,
	-691.68091, -887.75635, -1091.61377, -1303.10059,
	-1522.06421, -1747.89429, -1980.59082, -2219.84863,
	-2465.05737, -2715.91187, -2972.10693, -3233.18481,
	-3498.68774, -3768.00537, -4040.83252, -4316.55884,
	-4594.72656, -4874.72534, -5156.09741, -5438.23242,
	-5720.36743, -6002.19727, -6282.95898, -6562.19482,
	-6839.14185, -7113.18970, -7383.72803, -7650.29907,
	-7912.13989, -8168.64014, -8419.49463, -8663.63525,
	-8900.90942, -9130.55420, -9351.95923, -9564.81934,
	-9768.52417, -9962.46338, -10146.17920, -10319.36646,
	-10481.56738, -10632.17163, -10771.17920, -10897.82715,
	-11012.11548, -11113.73901, -11202.23999, -11277.46582,
	-11339.26392, -11387.63428, -11422.11914, -11442.87109,
	11449.89014, 11442.87109, 11422.11914, 11387.63428,
	11339.26392, 11277.46582, 11202.23999, 11113.73901,
	11012.11548, 10897.82715, 10771.17920, 1063.217163,
	10481.56738, 10319.36646, 10146.17920, 9962.46338,
	9768.52417, 9564.81934, 9351.95923, 9130.55420,
	8900.90942, 8663.63525, 8419.49463, 8168.64014,
	7912.13989, 7650.29907, 7383.72803, 7113.18970,
	6839.14185, 6562.19482, 6282.95898, 6002.19727,
	5720.36743, 5438.23242, 5156.09741, 4874.72534,
	4594.72656, 4316.55884, 4040.83252, 3768.00537,
	3498.68774, 3233.18481, 2972.10693, 2715.91187,
	2465.05737, 2219.84863, 1980.59082, 1747.89429,
	1522.06421, 1303.10059, 1091.61377, 887.75635,
	691.68091, 503.54004, 323.79150, 152.28271,
	-10.68115, -165.10010, -310.82153, -447.84546,
	-576.17187, -695.95337, -806.88477, -909.27124,
	1003.11279, 1088.56201, 1165.77148, 1234.74121,
	1295.77637, 1348.87695, 1394.50073, 1432.64771,
	1463.62305, 1487.73193, 1504.97437, 1515.96069,
	1520.69092, 1519.62280, 1513.06152, 1501.15967,
	1484.22241, 1462.55493, 1436.76758, 1406.70776,
	1372.98584, 1335.90698, 1295.62378, 1252.59399,
	1206.97021, 1159.21021, 1109.46655, 1058.19702,
	1005.40161, 951.69067, 897.06421, 841.82739,
	786.28540, 730.59082, 675.20142, 619.96460,
	565.33813, 511.32202, 458.37402, 406.34155,
	355.52979, 306.09131, 258.17871, 211.79199,
	167.08374, 124.20654, 83.16040, 43.94531,
	6.86646, -28.22876, -61.34033, -92.31567,
	-121.15479, -148.01025, -172.57690, -195.31250,
	-215.75928, -234.22241, -250.85449, -265.35034,
	-278.01514, -288.84888, -297.85156, -305.17578,
	310.82153, 314.78882, 317.38281, 318.45093,
	318.14575, 316.61987, 313.87329, 310.05859,
	305.32837, 299.37744, 292.81616, 285.33936,
	277.25220, 268.40210, 259.09424, 249.32861,
	239.10522, 228.57666, 217.89551, 206.90918,
	195.77026, 184.63135, 173.49243, 162.35352,
	151.21460, 140.22827, 129.39453, 118.86597,
	108.48999, 98.41919, 88.65356, 79.19312,
	70.03784, 61.18774, 52.94800, 44.86084,
	37.23145, 30.05981, 23.34595, 16.93726,
	10.98633, 5.49316, 0.30518, -4.42505,
	-8.69751, -12.66479, -16.17432, -19.37866,
	-22.27783, -24.87183, -27.00806, -28.83911,
	-30.51758, -31.73828, -32.80640, -33.72192,
	-34.17969, -34.63745, -34.79004, -34.79004,
	-34.63745, -34.33228, -33.87451, -33.26416,
	32.50122, 31.73828, 30.82275, 29.90723,
	28.99170, 27.92358, 26.85547, 25.78735,
	24.56665, 23.49854, 22.43042, 21.20972,
	20.14160, 19.07349, 17.85278, 16.93726,
	15.86914, 14.80103, 13.88550, 12.96997,
	12.05444, 11.13892, 10.37598, 9.61304,
	8.85010, 8.08716, 7.47681, 6.86646,
	6.25610, 5.79834, 5.34058, 4.73022,
	4.42505, 3.96729, 3.66211, 3.20435,
	2.89917, 2.59399, 2.44141, 2.13623,
	1.98364, 1.67847, 1.52588, 1.37329,
	1.22070, 1.06812, 1.06812, 0.91553,
	0.76294, 0.76294, 0.61035, 0.61035,
	0.45776, 0.45776, 0.30518, 0.30518,
	0.30518, 0.30518, 0.15259, 0.15259,
	0.15259, 0.15259, 0.15259, 0.15259
};
//static float _D[512] =
//{
//	0.000000000, -0.000015259, -0.000015259, -0.000015259,
//	-0.000015259, -0.000015259, -0.000015259, -0.000030518,
//	-0.000030518, -0.000030518, -0.000030518, -0.000045776,
//	-0.000045776, -0.000061035, -0.000061035, -0.000076294,
//	-0.000076294, -0.000091553, -0.000106812, -0.000106812,
//	-0.000122070, -0.000137329, -0.000152588, -0.000167847,
//	-0.000198364, -0.000213623, -0.000244141, -0.000259399,
//	-0.000289917, -0.000320435, -0.000366211, -0.000396729,
//	-0.000442505, -0.000473022, -0.000534058, -0.000579834,
//	-0.000625610, -0.000686646, -0.000747681, -0.000808716,
//	-0.000885010, -0.000961304, -0.001037598, -0.001113892,
//	-0.001205444, -0.001296997, -0.001388550, -0.001480103,
//	-0.001586914, -0.001693726, -0.001785278, -0.001907349,
//	-0.002014160, -0.002120972, -0.002243042, -0.002349854,
//	-0.002456665, -0.002578735, -0.002685547, -0.002792358,
//	-0.002899170, -0.002990723, -0.003082275, -0.003173828,
//	0.003250122, 0.003326416, 0.003387451, 0.003433228,
//	0.003463745, 0.003479004, 0.003479004, 0.003463745,
//	0.003417969, 0.003372192, 0.003280640, 0.003173828,
//	0.003051758, 0.002883911, 0.002700806, 0.002487183,
//	0.002227783, 0.001937866, 0.001617432, 0.001266479,
//	0.000869751, 0.000442505, -0.000030518, -0.000549316,
//	-0.001098633, -0.001693726, -0.002334595, -0.003005981,
//	-0.003723145, -0.004486084, -0.005294800, -0.006118774,
//	-0.007003784, -0.007919312, -0.008865356, -0.009841919,
//	-0.010848999, -0.011886597, -0.012939453, -0.014022827,
//	-0.015121460, -0.016235352, -0.017349243, -0.018463135,
//	-0.019577026, -0.020690918, -0.021789551, -0.022857666,
//	-0.023910522, -0.024932861, -0.025909424, -0.026840210,
//	-0.027725220, -0.028533936, -0.029281616, -0.029937744,
//	-0.030532837, -0.031005859, -0.031387329, -0.031661987,
//	-0.031814575, -0.031845093, -0.031738281, -0.031478882,
//	0.031082153, 0.030517578, 0.029785156, 0.028884888,
//	0.027801514, 0.026535034, 0.025085449, 0.023422241,
//	0.021575928, 0.019531250, 0.017257690, 0.014801025,
//	0.012115479, 0.009231567, 0.006134033, 0.002822876,
//	-0.000686646, -0.004394531, -0.008316040, -0.012420654,
//	-0.016708374, -0.021179199, -0.025817871, -0.030609131,
//	-0.035552979, -0.040634155, -0.045837402, -0.051132202,
//	-0.056533813, -0.061996460, -0.067520142, -0.073059082,
//	-0.078628540, -0.084182739, -0.089706421, -0.095169067,
//	-0.100540161, -0.105819702, -0.110946655, -0.115921021,
//	-0.120697021, -0.125259399, -0.129562378, -0.133590698,
//	-0.137298584, -0.140670776, -0.143676758, -0.146255493,
//	-0.148422241, -0.150115967, -0.151306152, -0.151962280,
//	-0.152069092, -0.151596069, -0.150497437, -0.148773193,
//	-0.146362305, -0.143264771, -0.139450073, -0.134887695,
//	-0.129577637, -0.123474121, -0.116577148, -0.108856201,
//	0.100311279, 0.090927124, 0.080688477, 0.069595337,
//	0.057617187, 0.044784546, 0.031082153, 0.016510010,
//	0.001068115, -0.015228271, -0.032379150, -0.050354004,
//	-0.069168091, -0.088775635, -0.109161377, -0.130310059,
//	-0.152206421, -0.174789429, -0.198059082, -0.221984863,
//	-0.246505737, -0.271591187, -0.297210693, -0.323318481,
//	-0.349868774, -0.376800537, -0.404083252, -0.431655884,
//	-0.459472656, -0.487472534, -0.515609741, -0.543823242,
//	-0.572036743, -0.600219727, -0.628295898, -0.656219482,
//	-0.683914185, -0.711318970, -0.738372803, -0.765029907,
//	-0.791213989, -0.816864014, -0.841949463, -0.866363525,
//	-0.890090942, -0.913055420, -0.935195923, -0.956481934,
//	-0.976852417, -0.996246338, -1.014617920, -1.031936646,
//	-1.048156738, -1.063217163, -1.077117920, -1.089782715,
//	-1.101211548, -1.111373901, -1.120223999, -1.127746582,
//	-1.133926392, -1.138763428, -1.142211914, -1.144287109,
//	1.144989014, 1.144287109, 1.142211914, 1.138763428,
//	1.133926392, 1.127746582, 1.120223999, 1.111373901,
//	1.101211548, 1.089782715, 1.077117920, 1.063217163,
//	1.048156738, 1.031936646, 1.014617920, 0.996246338,
//	0.976852417, 0.956481934, 0.935195923, 0.913055420,
//	0.890090942, 0.866363525, 0.841949463, 0.816864014,
//	0.791213989, 0.765029907, 0.738372803, 0.711318970,
//	0.683914185, 0.656219482, 0.628295898, 0.600219727,
//	0.572036743, 0.543823242, 0.515609741, 0.487472534,
//	0.459472656, 0.431655884, 0.404083252, 0.376800537,
//	0.349868774, 0.323318481, 0.297210693, 0.271591187,
//	0.246505737, 0.221984863, 0.198059082, 0.174789429,
//	0.152206421, 0.130310059, 0.109161377, 0.088775635,
//	0.069168091, 0.050354004, 0.032379150, 0.015228271,
//	-0.001068115, -0.016510010, -0.031082153, -0.044784546,
//	-0.057617187, -0.069595337, -0.080688477, -0.090927124,
//	0.100311279, 0.108856201, 0.116577148, 0.123474121,
//	0.129577637, 0.134887695, 0.139450073, 0.143264771,
//	0.146362305, 0.148773193, 0.150497437, 0.151596069,
//	0.152069092, 0.151962280, 0.151306152, 0.150115967,
//	0.148422241, 0.146255493, 0.143676758, 0.140670776,
//	0.137298584, 0.133590698, 0.129562378, 0.125259399,
//	0.120697021, 0.115921021, 0.110946655, 0.105819702,
//	0.100540161, 0.095169067, 0.089706421, 0.084182739,
//	0.078628540, 0.073059082, 0.067520142, 0.061996460,
//	0.056533813, 0.051132202, 0.045837402, 0.040634155,
//	0.035552979, 0.030609131, 0.025817871, 0.021179199,
//	0.016708374, 0.012420654, 0.008316040, 0.004394531,
//	0.000686646, -0.002822876, -0.006134033, -0.009231567,
//	-0.012115479, -0.014801025, -0.017257690, -0.019531250,
//	-0.021575928, -0.023422241, -0.025085449, -0.026535034,
//	-0.027801514, -0.028884888, -0.029785156, -0.030517578,
//	0.031082153, 0.031478882, 0.031738281, 0.031845093,
//	0.031814575, 0.031661987, 0.031387329, 0.031005859,
//	0.030532837, 0.029937744, 0.029281616, 0.028533936,
//	0.027725220, 0.026840210, 0.025909424, 0.024932861,
//	0.023910522, 0.022857666, 0.021789551, 0.020690918,
//	0.019577026, 0.018463135, 0.017349243, 0.016235352,
//	0.015121460, 0.014022827, 0.012939453, 0.011886597,
//	0.010848999, 0.009841919, 0.008865356, 0.007919312,
//	0.007003784, 0.006118774, 0.005294800, 0.004486084,
//	0.003723145, 0.003005981, 0.002334595, 0.001693726,
//	0.001098633, 0.000549316, 0.000030518, -0.000442505,
//	-0.000869751, -0.001266479, -0.001617432, -0.001937866,
//	-0.002227783, -0.002487183, -0.002700806, -0.002883911,
//	-0.003051758, -0.003173828, -0.003280640, -0.003372192,
//	-0.003417969, -0.003463745, -0.003479004, -0.003479004,
//	-0.003463745, -0.003433228, -0.003387451, -0.003326416,
//	0.003250122, 0.003173828, 0.003082275, 0.002990723,
//	0.002899170, 0.002792358, 0.002685547, 0.002578735,
//	0.002456665, 0.002349854, 0.002243042, 0.002120972,
//	0.002014160, 0.001907349, 0.001785278, 0.001693726,
//	0.001586914, 0.001480103, 0.001388550, 0.001296997,
//	0.001205444, 0.001113892, 0.001037598, 0.000961304,
//	0.000885010, 0.000808716, 0.000747681, 0.000686646,
//	0.000625610, 0.000579834, 0.000534058, 0.000473022,
//	0.000442505, 0.000396729, 0.000366211, 0.000320435,
//	0.000289917, 0.000259399, 0.000244141, 0.000213623,
//	0.000198364, 0.000167847, 0.000152588, 0.000137329,
//	0.000122070, 0.000106812, 0.000106812, 0.000091553,
//	0.000076294, 0.000076294, 0.000061035, 0.000061035,
//	0.000045776, 0.000045776, 0.000030518, 0.000030518,
//	0.000030518, 0.000030518, 0.000015259, 0.000015259,
//	0.000015259, 0.000015259, 0.000015259, 0.000015259
//};

static float _decwin[512 + 32];

/*
coefficients Nik for the synthesis window
*/
static float _N[64][32]; // need init ( _N[i][k] = cos((16+i)*(2*k+1)*PI/64) )
// static float _N[32][32]; // need init ( _N[i][k] = cos(i*(2*k+1)*PI/64) )

static float _U[512];
static float _V[2][1024];

//static void dct32to64(const float samples_in[32], int ch)
//{
//	float tmp[32];
//	int i;
//
//	for (i = 0; i < 32; ++i) {
//		tmp[i] = 0;
//		for (int k = 0; k < 32; ++k) {
//			tmp[i] += _N[i][k] * samples_in[k];
//		}
//	}
//
//	for (i = 0; i < 16; ++i) {
//		_V[ch][_V_index[ch] + i] = tmp[i + 16];
//	}
//	_V[ch][_V_index[ch] + i++] = 0;
//	for (; i < 48; ++i) {
//		_V[ch][_V_index[ch] + i] = -tmp[48 - i];
//	}
//	for (; i < 64; ++i) {
//		_V[ch][_V_index[ch] + i] = -tmp[i - 48];
//	}
//}

void init_synthesis_tabs(void)
{
	int i, j;

	for (i = 0; i < 64; ++i) {
		for (j = 0; j < 32; ++j) {
			// _N[i][k] = cos(i * (2.0 * k + 1) * PI / 64);
			_N[i][j] = (float)cos((16.0 + i) * (2.0 * j + 1.0) * M_PI / 64.0);
		}
	}

	//for (i = 0; i < 512; ++i) {
	//	_D[i] *= 32767.0;
	//}
}

#if 0
/*
mono:
pcm_out[0] --> left_lo -\ PCM Sample 1
pcm_out[1] --> left_hi -/

staereo:
pcm_out[0] --> left_lo	-\
pcm_out[1] --> left_hi	->\ PCM Sample 1
pcm_out[2] --> right_lo ->/
pcm_out[3] --> right_hi -/
*/
void synthesis_subband_filter(const float samples_in[32], char pcm_out[32 * 2 * 2], unsigned pcm_out_index[2], int ch, int nch)
{
	int i, j;
	// Shifting
	_V_index[ch] = (_V_index[ch] - 64) & 0x3ff;

	// Matrixing (DCT(32 -> 64))
	for (i = 0; i < 64; ++i) {
		float t_V = 0.0;
		for (j = 0; j < 32; ++j) {
			t_V += _N[i][j] * samples_in[j];
		}
		_V[ch][_V_index[ch] + i] = t_V;
	}
	// dct32to64(samples_in, ch);

	// Build a 512 values vector U
	for (i = 0; i < 8; ++i) {
		for (j = 0; j < 32; ++j) {
			/*_U[i * 64 + j] = _V[ch][i * 128 + j];
			_U[i * 64 + 32 + j] = _V[ch][i * 128 + 96 + j];*/
			_W[i * 64 + j] = _V[ch][i * 128 + j];
			_W[i * 64 + j + 32] = _V[ch][i * 128 + j + 96];
		}
	}
	//for (int i = 0; i < 512; i += 64) {
	//	for (int j = 0; j < 32; ++j) {
	//		_U[i + j] = _V[ch][i * 2 + j];
	//		_U[i + j + 32] = _V[ch][i * 2 + j + 96];
	//	}
	//}

	// Window by 512 coefficients
	for (i = 0; i < 512; ++i) {
		/*_W[i] = _U[i] * _D[i];*/
		_W[i] *= _D[i];
	}

	//// Build a 512 values vector U
	//// Window by 512 coefficients
	//for (int i = 0; i < 512; i += 64) {
	//	for (int j = 0; j < 32; ++j) {
	//		_W[i + j] = _V[ch][i * 2 + j] * _D[i + j];
	//		_W[i + j + 32] = _V[ch][i * 2 + j + 96] * _D[i + j];
	//	}
	//}

	// Calculate 32 Samples
	//unsigned step = nch << 1;
	//for (int i = 0; i < 32; ++i) {
	//	float t_S = 0;
	//	for (int j = 0; j < 16; ++j) {
	//		t_S += _W[i + 32 * j];
	//	}
	//	// Output 32 reconstructed PCM Samples
	//	pcm_out[pcm_out_index[ch]] = ((char*)&t_S)[0];
	//	pcm_out[pcm_out_index[ch] + 1] = ((char*)&t_S)[1];
	//	pcm_out_index[ch] += step;
	//}
	unsigned step = nch << 1;
	for (i = 0; i < 32; ++i) {
		float t_S = 0;
		for (j = 0; j < 512; j += 32) {
			t_S += _W[i + j];
		}
		// t_S *= 32767.0;
		// Output 32 reconstructed PCM Samples
		short pcm_i;
		if (t_S > 32767.0) {
			/*pcm_out[pcm_out_index[ch]] = 0xf;
			pcm_out[pcm_out_index[ch] + 1] = 0x7;*/
			pcm_i = 32767;
		} else if (t_S < -32768.0) {
			/*pcm_out[pcm_out_index[ch]] = 0;
			pcm_out[pcm_out_index[ch] + 1] = 0x80;*/
			pcm_i = -32768;
		} else {
			pcm_i = (short)(t_S + 0.5);
			// memcpy(&pcm_i, &t_S, 2);
			/*pcm_out[pcm_out_index[ch]] = (char)pcm_i;
			pcm_out[pcm_out_index[ch] + 1] = (char)((pcm_i >> 8) & 0xff);*/
		}
		// pcm_i >>= 1;
		//pcm_out[pcm_out_index[ch]] = (char)pcm_i;
		//pcm_out[pcm_out_index[ch] + 1] = (char)(pcm_i >> 8);
		/**(short*)(pcm_out + pcm_out_index[ch]) = *(short*)&pcm_i;*/
		pcm_out[pcm_out_index[ch]] = (char)pcm_i;
		pcm_out[pcm_out_index[ch] + 1] = (char)(pcm_i >> 8);
		pcm_out_index[ch] += step;
	}
}
#endif

void synthesis_subband_filter(const float xr[32 * 18], struct pcm_stream* const pcm_out, int ch, int nch)
{
	int i, j;
	unsigned step = nch << 1;

	for (int ss = 0; ss < 18; ++ss) {
		// Shifting
		for (i = 1023; i > 63; --i)
			_V[ch][i] = _V[ch][i - 64];

		// Matrixing (DCT(32 -> 64))
		for (i = 0; i < 64; ++i) {
			_V[ch][i] = 0.0f;
			for (j = 0; j < 32; ++j) {
				_V[ch][i] += _N[i][j] * xr[j * 18 + ss];
			}
		}

		/*
		* Build a 512 values vector U
		* Window by 512 coefficients
		*/
		for (i = 0; i < 512; i += 64) {
			for (j = 0; j < 32; ++j) {
				_U[i + j] = _V[ch][i * 2 + j] * _D[i + j];
				_U[i + j + 32] = _V[ch][i * 2 + j + 96] * _D[i + j + 32];
			}
		}

		/*
		* Calculate 32 Samples
		* Output 32 reconstructed PCM Samples
		*/
		for (i = 0; i < 32; ++i) {
			float sum = 0.0f;
			for (j = 0; j < 512; j += 32) {
				sum += _U[i + j];
			}

			// Output reconstructed PCM Sample
			int pcm_i = (int)(sum * 3.2767f);
			if (pcm_i > 32767) {
				pcm_i = 32767;
			} else if (pcm_i < -32768) {
				pcm_i = -32768;
			}
			pcm_i &= 0xffff;

			pcm_out->pcm_buf[pcm_out->write_off[ch]] = pcm_i & 0xff;
			pcm_out->pcm_buf[pcm_out->write_off[ch] + 1] = pcm_i >> 8;
			pcm_out->write_off[ch] += step;
		}
	}
}
