#include "synth.h"
#include <math.h>

#define M_PI       3.14159265358979323846
#define M_SQRT2	1.41421356237309504880

/*
coefficients Di for the synthesis window
*/
#if 0
static float _D[512] =
{
	0.00000, -0.15259, -0.15259, -0.15259,
	-0.15259, -0.15259, -0.15259, -0.30518,
	-0.30518, -0.30518, -0.30518, -0.45776,
	-0.45776, -0.61035, -0.61035, -0.76294,
	-0.76294, -0.91553, -1.06812, -1.06812,
	-1.22070, -1.37329, -1.52588, -1.67847,
	-1.98364, -2.13623, -2.44141, -2.59399,
	-2.89917, -3.20435, -3.66211, -3.96729,
	-4.42505, -4.73022, -5.34058, -5.79834,
	-6.25610, -6.86646, -7.47681, -8.08716,
	-8.85010, -9.61304, -10.37598, -11.13892,
	-12.05444, -12.96997, -13.88550, -14.80103,
	-15.86914, -16.93726, -17.85278, -19.07349,
	-20.14160, -21.20972, -22.43042, -23.49854,
	-24.56665, -25.78735, -26.85547, -27.92358,
	-28.99170, -29.90723, -30.82275, -31.73828,
	32.50122, 33.26416, 33.87451, 34.33228,
	34.63745, 34.79004, 34.79004, 34.63745,
	34.17969, 33.72192, 32.80640, 31.73828,
	30.51758, 28.83911, 27.00806, 24.87183,
	22.27783, 19.37866, 16.17432, 12.66479,
	8.69751, 4.42505, -0.30518, -5.49316,
	-10.98633, -16.93726, -23.34595, -30.05981,
	-37.23145, -44.86084, -52.94800, -61.18774,
	-70.03784, -79.19312, -88.65356, -98.41919,
	-108.48999, -118.86597, -129.39453, -140.22827,
	-151.21460, -162.35352, -173.49243, -184.63135,
	-195.77026, -206.90918, -217.89551, -228.57666,
	-239.10522, -249.32861, -259.09424, -268.40210,
	-277.25220, -285.33936, -292.81616, -299.37744,
	-305.32837, -310.05859, -313.87329, -316.61987,
	-318.14575, -318.45093, -317.38281, -314.78882,
	310.82153, 305.17578, 297.85156, 288.84888,
	278.01514, 265.35034, 250.85449, 234.22241,
	215.75928, 195.31250, 172.57690, 148.01025,
	121.15479, 92.31567, 61.34033, 28.22876,
	-6.86646, -43.94531, -83.16040, -124.20654,
	-167.08374, -211.79199, -258.17871, -306.09131,
	-355.52979, -406.34155, -458.37402, -511.32202,
	-565.33813, -619.96460, -675.20142, -730.59082,
	-786.28540, -841.82739, -897.06421, -951.69067,
	-1005.40161, -1058.19702, -1109.46655, -1159.21021,
	-1206.97021, -1252.59399, -1295.62378, -1335.90698,
	-1372.98584, -1406.70776, -1436.76758, -1462.55493,
	-1484.22241, -1501.15967, -1513.06152, -1519.62280,
	-1520.69092, -1515.96069, -1504.97437, -1487.73193,
	-1463.62305, -1432.64771, -1394.50073, -1348.87695,
	-1295.77637, -1234.74121, -1165.77148, -1088.56201,
	1003.11279, 909.27124, 806.88477, 695.95337,
	576.17187, 447.84546, 3108.2153, 165.10010,
	10.68115, -152.28271, -323.79150, -503.54004,
	-691.68091, -887.75635, -1091.61377, -1303.10059,
	-1522.06421, -1747.89429, -1980.59082, -2219.84863,
	-2465.05737, -2715.91187, -2972.10693, -3233.18481,
	-3498.68774, -3768.00537, -4040.83252, -4316.55884,
	-4594.72656, -4874.72534, -5156.09741, -5438.23242,
	-5720.36743, -6002.19727, -6282.95898, -6562.19482,
	-6839.14185, -7113.18970, -7383.72803, -7650.29907,
	-7912.13989, -8168.64014, -8419.49463, -8663.63525,
	-8900.90942, -9130.55420, -9351.95923, -9564.81934,
	-9768.52417, -9962.46338, -10146.17920, -10319.36646,
	-10481.56738, -10632.17163, -10771.17920, -10897.82715,
	-11012.11548, -11113.73901, -11202.23999, -11277.46582,
	-11339.26392, -11387.63428, -11422.11914, -11442.87109,
	11449.89014, 11442.87109, 11422.11914, 11387.63428,
	11339.26392, 11277.46582, 11202.23999, 11113.73901,
	11012.11548, 10897.82715, 10771.17920, 1063.217163,
	10481.56738, 10319.36646, 10146.17920, 9962.46338,
	9768.52417, 9564.81934, 9351.95923, 9130.55420,
	8900.90942, 8663.63525, 8419.49463, 8168.64014,
	7912.13989, 7650.29907, 7383.72803, 7113.18970,
	6839.14185, 6562.19482, 6282.95898, 6002.19727,
	5720.36743, 5438.23242, 5156.09741, 4874.72534,
	4594.72656, 4316.55884, 4040.83252, 3768.00537,
	3498.68774, 3233.18481, 2972.10693, 2715.91187,
	2465.05737, 2219.84863, 1980.59082, 1747.89429,
	1522.06421, 1303.10059, 1091.61377, 887.75635,
	691.68091, 503.54004, 323.79150, 152.28271,
	-10.68115, -165.10010, -310.82153, -447.84546,
	-576.17187, -695.95337, -806.88477, -909.27124,
	1003.11279, 1088.56201, 1165.77148, 1234.74121,
	1295.77637, 1348.87695, 1394.50073, 1432.64771,
	1463.62305, 1487.73193, 1504.97437, 1515.96069,
	1520.69092, 1519.62280, 1513.06152, 1501.15967,
	1484.22241, 1462.55493, 1436.76758, 1406.70776,
	1372.98584, 1335.90698, 1295.62378, 1252.59399,
	1206.97021, 1159.21021, 1109.46655, 1058.19702,
	1005.40161, 951.69067, 897.06421, 841.82739,
	786.28540, 730.59082, 675.20142, 619.96460,
	565.33813, 511.32202, 458.37402, 406.34155,
	355.52979, 306.09131, 258.17871, 211.79199,
	167.08374, 124.20654, 83.16040, 43.94531,
	6.86646, -28.22876, -61.34033, -92.31567,
	-121.15479, -148.01025, -172.57690, -195.31250,
	-215.75928, -234.22241, -250.85449, -265.35034,
	-278.01514, -288.84888, -297.85156, -305.17578,
	310.82153, 314.78882, 317.38281, 318.45093,
	318.14575, 316.61987, 313.87329, 310.05859,
	305.32837, 299.37744, 292.81616, 285.33936,
	277.25220, 268.40210, 259.09424, 249.32861,
	239.10522, 228.57666, 217.89551, 206.90918,
	195.77026, 184.63135, 173.49243, 162.35352,
	151.21460, 140.22827, 129.39453, 118.86597,
	108.48999, 98.41919, 88.65356, 79.19312,
	70.03784, 61.18774, 52.94800, 44.86084,
	37.23145, 30.05981, 23.34595, 16.93726,
	10.98633, 5.49316, 0.30518, -4.42505,
	-8.69751, -12.66479, -16.17432, -19.37866,
	-22.27783, -24.87183, -27.00806, -28.83911,
	-30.51758, -31.73828, -32.80640, -33.72192,
	-34.17969, -34.63745, -34.79004, -34.79004,
	-34.63745, -34.33228, -33.87451, -33.26416,
	32.50122, 31.73828, 30.82275, 29.90723,
	28.99170, 27.92358, 26.85547, 25.78735,
	24.56665, 23.49854, 22.43042, 21.20972,
	20.14160, 19.07349, 17.85278, 16.93726,
	15.86914, 14.80103, 13.88550, 12.96997,
	12.05444, 11.13892, 10.37598, 9.61304,
	8.85010, 8.08716, 7.47681, 6.86646,
	6.25610, 5.79834, 5.34058, 4.73022,
	4.42505, 3.96729, 3.66211, 3.20435,
	2.89917, 2.59399, 2.44141, 2.13623,
	1.98364, 1.67847, 1.52588, 1.37329,
	1.22070, 1.06812, 1.06812, 0.91553,
	0.76294, 0.76294, 0.61035, 0.61035,
	0.45776, 0.45776, 0.30518, 0.30518,
	0.30518, 0.30518, 0.15259, 0.15259,
	0.15259, 0.15259, 0.15259, 0.15259
};
#else
static const float _D[512] =
{
	0.000000000f, -0.000015259f, -0.000015259f, -0.000015259f,
	-0.000015259f, -0.000015259f, -0.000015259f, -0.000030518f,
	-0.000030518f, -0.000030518f, -0.000030518f, -0.000045776f,
	-0.000045776f, -0.000061035f, -0.000061035f, -0.000076294f,
	-0.000076294f, -0.000091553f, -0.000106812f, -0.000106812f,
	-0.000122070f, -0.000137329f, -0.000152588f, -0.000167847f,
	-0.000198364f, -0.000213623f, -0.000244141f, -0.000259399f,
	-0.000289917f, -0.000320435f, -0.000366211f, -0.000396729f,
	-0.000442505f, -0.000473022f, -0.000534058f, -0.000579834f,
	-0.000625610f, -0.000686646f, -0.000747681f, -0.000808716f,
	-0.000885010f, -0.000961304f, -0.001037598f, -0.001113892f,
	-0.001205444f, -0.001296997f, -0.001388550f, -0.001480103f,
	-0.001586914f, -0.001693726f, -0.001785278f, -0.001907349f,
	-0.002014160f, -0.002120972f, -0.002243042f, -0.002349854f,
	-0.002456665f, -0.002578735f, -0.002685547f, -0.002792358f,
	-0.002899170f, -0.002990723f, -0.003082275f, -0.003173828f,
	0.003250122f, 0.003326416f, 0.003387451f, 0.003433228f,
	0.003463745f, 0.003479004f, 0.003479004f, 0.003463745f,
	0.003417969f, 0.003372192f, 0.003280640f, 0.003173828f,
	0.003051758f, 0.002883911f, 0.002700806f, 0.002487183f,
	0.002227783f, 0.001937866f, 0.001617432f, 0.001266479f,
	0.000869751f, 0.000442505f, -0.000030518f, -0.000549316f,
	-0.001098633f, -0.001693726f, -0.002334595f, -0.003005981f,
	-0.003723145f, -0.004486084f, -0.005294800f, -0.006118774f,
	-0.007003784f, -0.007919312f, -0.008865356f, -0.009841919f,
	-0.010848999f, -0.011886597f, -0.012939453f, -0.014022827f,
	-0.015121460f, -0.016235352f, -0.017349243f, -0.018463135f,
	-0.019577026f, -0.020690918f, -0.021789551f, -0.022857666f,
	-0.023910522f, -0.024932861f, -0.025909424f, -0.026840210f,
	-0.027725220f, -0.028533936f, -0.029281616f, -0.029937744f,
	-0.030532837f, -0.031005859f, -0.031387329f, -0.031661987f,
	-0.031814575f, -0.031845093f, -0.031738281f, -0.031478882f,
	0.031082153f, 0.030517578f, 0.029785156f, 0.028884888f,
	0.027801514f, 0.026535034f, 0.025085449f, 0.023422241f,
	0.021575928f, 0.019531250f, 0.017257690f, 0.014801025f,
	0.012115479f, 0.009231567f, 0.006134033f, 0.002822876f,
	-0.000686646f, -0.004394531f, -0.008316040f, -0.012420654f,
	-0.016708374f, -0.021179199f, -0.025817871f, -0.030609131f,
	-0.035552979f, -0.040634155f, -0.045837402f, -0.051132202f,
	-0.056533813f, -0.061996460f, -0.067520142f, -0.073059082f,
	-0.078628540f, -0.084182739f, -0.089706421f, -0.095169067f,
	-0.100540161f, -0.105819702f, -0.110946655f, -0.115921021f,
	-0.120697021f, -0.125259399f, -0.129562378f, -0.133590698f,
	-0.137298584f, -0.140670776f, -0.143676758f, -0.146255493f,
	-0.148422241f, -0.150115967f, -0.151306152f, -0.151962280f,
	-0.152069092f, -0.151596069f, -0.150497437f, -0.148773193f,
	-0.146362305f, -0.143264771f, -0.139450073f, -0.134887695f,
	-0.129577637f, -0.123474121f, -0.116577148f, -0.108856201f,
	0.100311279f, 0.090927124f, 0.080688477f, 0.069595337f,
	0.057617187f, 0.044784546f, 0.031082153f, 0.016510010f,
	0.001068115f, -0.015228271f, -0.032379150f, -0.050354004f,
	-0.069168091f, -0.088775635f, -0.109161377f, -0.130310059f,
	-0.152206421f, -0.174789429f, -0.198059082f, -0.221984863f,
	-0.246505737f, -0.271591187f, -0.297210693f, -0.323318481f,
	-0.349868774f, -0.376800537f, -0.404083252f, -0.431655884f,
	-0.459472656f, -0.487472534f, -0.515609741f, -0.543823242f,
	-0.572036743f, -0.600219727f, -0.628295898f, -0.656219482f,
	-0.683914185f, -0.711318970f, -0.738372803f, -0.765029907f,
	-0.791213989f, -0.816864014f, -0.841949463f, -0.866363525f,
	-0.890090942f, -0.913055420f, -0.935195923f, -0.956481934f,
	-0.976852417f, -0.996246338f, -1.014617920f, -1.031936646f,
	-1.048156738f, -1.063217163f, -1.077117920f, -1.089782715f,
	-1.101211548f, -1.111373901f, -1.120223999f, -1.127746582f,
	-1.133926392f, -1.138763428f, -1.142211914f, -1.144287109f,
	1.144989014f, 1.144287109f, 1.142211914f, 1.138763428f,
	1.133926392f, 1.127746582f, 1.120223999f, 1.111373901f,
	1.101211548f, 1.089782715f, 1.077117920f, 1.063217163f,
	1.048156738f, 1.031936646f, 1.014617920f, 0.996246338f,
	0.976852417f, 0.956481934f, 0.935195923f, 0.913055420f,
	0.890090942f, 0.866363525f, 0.841949463f, 0.816864014f,
	0.791213989f, 0.765029907f, 0.738372803f, 0.711318970f,
	0.683914185f, 0.656219482f, 0.628295898f, 0.600219727f,
	0.572036743f, 0.543823242f, 0.515609741f, 0.487472534f,
	0.459472656f, 0.431655884f, 0.404083252f, 0.376800537f,
	0.349868774f, 0.323318481f, 0.297210693f, 0.271591187f,
	0.246505737f, 0.221984863f, 0.198059082f, 0.174789429f,
	0.152206421f, 0.130310059f, 0.109161377f, 0.088775635f,
	0.069168091f, 0.050354004f, 0.032379150f, 0.015228271f,
	-0.001068115f, -0.016510010f, -0.031082153f, -0.044784546f,
	-0.057617187f, -0.069595337f, -0.080688477f, -0.090927124f,
	0.100311279f, 0.108856201f, 0.116577148f, 0.123474121f,
	0.129577637f, 0.134887695f, 0.139450073f, 0.143264771f,
	0.146362305f, 0.148773193f, 0.150497437f, 0.151596069f,
	0.152069092f, 0.151962280f, 0.151306152f, 0.150115967f,
	0.148422241f, 0.146255493f, 0.143676758f, 0.140670776f,
	0.137298584f, 0.133590698f, 0.129562378f, 0.125259399f,
	0.120697021f, 0.115921021f, 0.110946655f, 0.105819702f,
	0.100540161f, 0.095169067f, 0.089706421f, 0.084182739f,
	0.078628540f, 0.073059082f, 0.067520142f, 0.061996460f,
	0.056533813f, 0.051132202f, 0.045837402f, 0.040634155f,
	0.035552979f, 0.030609131f, 0.025817871f, 0.021179199f,
	0.016708374f, 0.012420654f, 0.008316040f, 0.004394531f,
	0.000686646f, -0.002822876f, -0.006134033f, -0.009231567f,
	-0.012115479f, -0.014801025f, -0.017257690f, -0.019531250f,
	-0.021575928f, -0.023422241f, -0.025085449f, -0.026535034f,
	-0.027801514f, -0.028884888f, -0.029785156f, -0.030517578f,
	0.031082153f, 0.031478882f, 0.031738281f, 0.031845093f,
	0.031814575f, 0.031661987f, 0.031387329f, 0.031005859f,
	0.030532837f, 0.029937744f, 0.029281616f, 0.028533936f,
	0.027725220f, 0.026840210f, 0.025909424f, 0.024932861f,
	0.023910522f, 0.022857666f, 0.021789551f, 0.020690918f,
	0.019577026f, 0.018463135f, 0.017349243f, 0.016235352f,
	0.015121460f, 0.014022827f, 0.012939453f, 0.011886597f,
	0.010848999f, 0.009841919f, 0.008865356f, 0.007919312f,
	0.007003784f, 0.006118774f, 0.005294800f, 0.004486084f,
	0.003723145f, 0.003005981f, 0.002334595f, 0.001693726f,
	0.001098633f, 0.000549316f, 0.000030518f, -0.000442505f,
	-0.000869751f, -0.001266479f, -0.001617432f, -0.001937866f,
	-0.002227783f, -0.002487183f, -0.002700806f, -0.002883911f,
	-0.003051758f, -0.003173828f, -0.003280640f, -0.003372192f,
	-0.003417969f, -0.003463745f, -0.003479004f, -0.003479004f,
	-0.003463745f, -0.003433228f, -0.003387451f, -0.003326416f,
	0.003250122f, 0.003173828f, 0.003082275f, 0.002990723f,
	0.002899170f, 0.002792358f, 0.002685547f, 0.002578735f,
	0.002456665f, 0.002349854f, 0.002243042f, 0.002120972f,
	0.002014160f, 0.001907349f, 0.001785278f, 0.001693726f,
	0.001586914f, 0.001480103f, 0.001388550f, 0.001296997f,
	0.001205444f, 0.001113892f, 0.001037598f, 0.000961304f,
	0.000885010f, 0.000808716f, 0.000747681f, 0.000686646f,
	0.000625610f, 0.000579834f, 0.000534058f, 0.000473022f,
	0.000442505f, 0.000396729f, 0.000366211f, 0.000320435f,
	0.000289917f, 0.000259399f, 0.000244141f, 0.000213623f,
	0.000198364f, 0.000167847f, 0.000152588f, 0.000137329f,
	0.000122070f, 0.000106812f, 0.000106812f, 0.000091553f,
	0.000076294f, 0.000076294f, 0.000061035f, 0.000061035f,
	0.000045776f, 0.000045776f, 0.000030518f, 0.000030518f,
	0.000030518f, 0.000030518f, 0.000015259f, 0.000015259f,
	0.000015259f, 0.000015259f, 0.000015259f, 0.000015259f
};
#endif

//static float _decwin[512 + 32];

/*
coefficients Nik for the synthesis window
*/
static float _N[64][32]; // need init ( _N[i][k] = cos((16+i)*(2*k+1)*PI/64) )
// static float _N[32][32]; // need init ( _N[i][k] = cos(i*(2*k+1)*PI/64) )

static float _U[512];
static float _V[2][1024];

//static void dct32to64(const float samples_in[32], int ch)
//{
//	float tmp[32];
//	int i;
//
//	for (i = 0; i < 32; ++i) {
//		tmp[i] = 0;
//		for (int k = 0; k < 32; ++k) {
//			tmp[i] += _N[i][k] * samples_in[k];
//		}
//	}
//
//	for (i = 0; i < 16; ++i) {
//		_V[ch][_V_index[ch] + i] = tmp[i + 16];
//	}
//	_V[ch][_V_index[ch] + i++] = 0;
//	for (; i < 48; ++i) {
//		_V[ch][_V_index[ch] + i] = -tmp[48 - i];
//	}
//	for (; i < 64; ++i) {
//		_V[ch][_V_index[ch] + i] = -tmp[i - 48];
//	}
//}

void init_synthesis_tabs(void)
{
	int i, j;

	for (i = 0; i < 64; ++i) {
		for (j = 0; j < 32; ++j) {
			// _N[i][k] = cos(i * (2.0 * k + 1) * PI / 64);
			_N[i][j] = (float)cos((16.0 + i) * (2.0 * j + 1.0) * M_PI / 64.0);
		}
	}

	//for (i = 0; i < 512; ++i) {
	//	_D[i] *= 32767.0;
	//}
}

#if 0
/*
mono:
pcm_out[0] --> left_lo -\ PCM Sample 1
pcm_out[1] --> left_hi -/

staereo:
pcm_out[0] --> left_lo	-\
pcm_out[1] --> left_hi	->\ PCM Sample 1
pcm_out[2] --> right_lo ->/
pcm_out[3] --> right_hi -/
*/
void synthesis_subband_filter(const float samples_in[32], char pcm_out[32 * 2 * 2], unsigned pcm_out_index[2], int ch, int nch)
{
	int i, j;
	// Shifting
	_V_index[ch] = (_V_index[ch] - 64) & 0x3ff;

	// Matrixing (DCT(32 -> 64))
	for (i = 0; i < 64; ++i) {
		float t_V = 0.0;
		for (j = 0; j < 32; ++j) {
			t_V += _N[i][j] * samples_in[j];
		}
		_V[ch][_V_index[ch] + i] = t_V;
	}
	// dct32to64(samples_in, ch);

	// Build a 512 values vector U
	for (i = 0; i < 8; ++i) {
		for (j = 0; j < 32; ++j) {
			/*_U[i * 64 + j] = _V[ch][i * 128 + j];
			_U[i * 64 + 32 + j] = _V[ch][i * 128 + 96 + j];*/
			_W[i * 64 + j] = _V[ch][i * 128 + j];
			_W[i * 64 + j + 32] = _V[ch][i * 128 + j + 96];
		}
	}
	//for (int i = 0; i < 512; i += 64) {
	//	for (int j = 0; j < 32; ++j) {
	//		_U[i + j] = _V[ch][i * 2 + j];
	//		_U[i + j + 32] = _V[ch][i * 2 + j + 96];
	//	}
	//}

	// Window by 512 coefficients
	for (i = 0; i < 512; ++i) {
		/*_W[i] = _U[i] * _D[i];*/
		_W[i] *= _D[i];
	}

	//// Build a 512 values vector U
	//// Window by 512 coefficients
	//for (int i = 0; i < 512; i += 64) {
	//	for (int j = 0; j < 32; ++j) {
	//		_W[i + j] = _V[ch][i * 2 + j] * _D[i + j];
	//		_W[i + j + 32] = _V[ch][i * 2 + j + 96] * _D[i + j];
	//	}
	//}

	// Calculate 32 Samples
	//unsigned step = nch << 1;
	//for (int i = 0; i < 32; ++i) {
	//	float t_S = 0;
	//	for (int j = 0; j < 16; ++j) {
	//		t_S += _W[i + 32 * j];
	//	}
	//	// Output 32 reconstructed PCM Samples
	//	pcm_out[pcm_out_index[ch]] = ((char*)&t_S)[0];
	//	pcm_out[pcm_out_index[ch] + 1] = ((char*)&t_S)[1];
	//	pcm_out_index[ch] += step;
	//}
	unsigned step = nch << 1;
	for (i = 0; i < 32; ++i) {
		float t_S = 0;
		for (j = 0; j < 512; j += 32) {
			t_S += _W[i + j];
		}
		// t_S *= 32767.0;
		// Output 32 reconstructed PCM Samples
		short pcm_i;
		if (t_S > 32767.0) {
			/*pcm_out[pcm_out_index[ch]] = 0xf;
			pcm_out[pcm_out_index[ch] + 1] = 0x7;*/
			pcm_i = 32767;
		} else if (t_S < -32768.0) {
			/*pcm_out[pcm_out_index[ch]] = 0;
			pcm_out[pcm_out_index[ch] + 1] = 0x80;*/
			pcm_i = -32768;
		} else {
			pcm_i = (short)(t_S + 0.5);
			// memcpy(&pcm_i, &t_S, 2);
			/*pcm_out[pcm_out_index[ch]] = (char)pcm_i;
			pcm_out[pcm_out_index[ch] + 1] = (char)((pcm_i >> 8) & 0xff);*/
		}
		// pcm_i >>= 1;
		//pcm_out[pcm_out_index[ch]] = (char)pcm_i;
		//pcm_out[pcm_out_index[ch] + 1] = (char)(pcm_i >> 8);
		/**(short*)(pcm_out + pcm_out_index[ch]) = *(short*)&pcm_i;*/
		pcm_out[pcm_out_index[ch]] = (char)pcm_i;
		pcm_out[pcm_out_index[ch] + 1] = (char)(pcm_i >> 8);
		pcm_out_index[ch] += step;
	}
}
#endif

void synthesis_subband_filter(const float xr[32 * 18], struct pcm_stream* const pcm_out, int ch, int nch)
{
	int i, j;
	unsigned step = nch << 1;

	for (int ss = 0; ss < 18; ++ss) {
		// Shifting
		for (i = 1023; i > 63; --i)
			_V[ch][i] = _V[ch][i - 64];

		// Matrixing (DCT(32 -> 64))
		for (i = 0; i < 64; ++i) {
			_V[ch][i] = 0.0f;
			for (j = 0; j < 32; ++j) {
				_V[ch][i] += _N[i][j] * xr[j * 18 + ss];
			}
		}

		/*
		* Build a 512 values vector U
		* Window by 512 coefficients
		*/
		for (i = 0; i < 512; i += 64) {
			for (j = 0; j < 32; ++j) {
				_U[i + j] = _V[ch][i * 2 + j] * _D[i + j];
				_U[i + j + 32] = _V[ch][i * 2 + j + 96] * _D[i + j + 32];
			}
		}

		/*
		* Calculate 32 Samples
		* Output 32 reconstructed PCM Samples
		*/
		for (i = 0; i < 32; ++i) {
			float sum = 0.0f;
			for (j = 0; j < 512; j += 32) {
				sum += _U[i + j];
			}

			// Output reconstructed PCM Sample
			int pcm_i = (int)(sum * 32767.0f + 0.5f);
			if (pcm_i > 32767) {
				pcm_i = 32767;
			} else if (pcm_i < -32768) {
				pcm_i = -32768;
			}
			pcm_i &= 0xffff;

			pcm_out->pcm_buf[pcm_out->write_off[ch]] = pcm_i & 0xff;
			pcm_out->pcm_buf[pcm_out->write_off[ch] + 1] = pcm_i >> 8;
			pcm_out->write_off[ch] += step;
		}
	}
}
